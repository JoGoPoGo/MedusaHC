[gcode_macro STORE_RAW_TOOL_XY]
description: Store current G-code XY into RAW_BALL_CENTER for the currently installed tool (XY only)
gcode:
  {% set max_tool = printer["gcode_macro TOOL_CFG"].max_tool|default(4)|int %}
  {% set T = printer["gcode_macro GLOBAL_STATE"].current_tool|default(-2)|int %}

  {% if T < 0 or T >= max_tool %}
    RESPOND MSG="STORE_RAW_TOOL_XY: current_tool={{T}} (range 0..{{max_tool-1}}). ABORT."
  {% else %}
    {% set x = printer.toolhead.position.x|float %}
    {% set y = printer.toolhead.position.y|float %}
    {% set vx = "t%d_center_x" % T %}
    {% set vy = "t%d_center_y" % T %}

    SET_GCODE_VARIABLE MACRO=RAW_BALL_CENTER VARIABLE={vx} VALUE={x}
    SET_GCODE_VARIABLE MACRO=RAW_BALL_CENTER VARIABLE={vy} VALUE={y}

    RESPOND MSG="STORE_RAW_TOOL_XY: saved T{{T}} X={{'%0.4f'|format(x)}} Y={{'%0.4f'|format(y)}}"
  {% endif %}


[gcode_macro CAM_CAL_CFG]
description: Camera calibration helper config (tune these)
variable_cam_center_x: 211.3
variable_cam_center_y: 210.0
variable_cam_z: 70.0
variable_f_xy: 12000
variable_f_z: 4000
gcode:
  ; no gcode


[gcode_macro CAM_CAL_GOTO]
description: Go to camera center at CAM_CAL_CFG.cam_z with selected tool. Usage: CAM_CAL_GOTO T=0..N
gcode:
  {% set T = params.T|default(-1)|int %}
  {% set homed = printer.toolhead.homed_axes|string %}

  {% if ('x' not in homed) or ('y' not in homed) or ('z' not in homed) %}
    RESPOND MSG="CAM_CAL_GOTO: NOT HOMED (homed_axes='{{homed}}'). Do a SAFE HOME first. ABORT."
  {% else %}
    {% set max_tool = printer["gcode_macro TOOL_CFG"].max_tool|default(4)|int %}
    {% if T < 0 or T >= max_tool %}
      RESPOND MSG="CAM_CAL_GOTO: bad T={{T}} (range 0..{{max_tool-1}}). ABORT."
    {% else %}
      {% set cfg = printer["gcode_macro CAM_CAL_CFG"] %}
      {% set cx = cfg.cam_center_x|float %}
      {% set cy = cfg.cam_center_y|float %}
      {% set cz = cfg.cam_z|float %}
      {% set fxy = cfg.f_xy|int %}
      {% set fz  = cfg.f_z|int %}

      {% if cz <= 0 %}
        RESPOND MSG="CAM_CAL_GOTO: CAM_CAL_CFG.cam_z={{cz}} is invalid (<=0). ABORT."
      {% else %}
        SET T{T}
        G90
        G1 Z{cz:.3f} F{fz}
        G1 X{cx:.3f} Y{cy:.3f} F{fxy}
        RESPOND MSG="CAM_CAL_GOTO: ready for manual align. Then run STORE_RAW_TOOL_XY"
      {% endif %}
    {% endif %}
  {% endif %}
